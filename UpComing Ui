--[[
    Avenir Library - Linoria Style 
    With DPI Scaling, Mobile Support, Keybind List & Watermark
]]

-- Variables 
    local uis = game:GetService("UserInputService") 
    local players = game:GetService("Players") 
    local ws = game:GetService("Workspace")
    local http_service = game:GetService("HttpService")
    local gui_service = game:GetService("GuiService")
    local run = game:GetService("RunService")
    local coregui = game:GetService("CoreGui")
    local tween_service = game:GetService("TweenService")
    local stats_service = game:GetService("Stats")

    local vec2 = Vector2.new
    local dim2 = UDim2.new
    local dim = UDim.new 
    local dim_offset = UDim2.fromOffset

    local color = Color3.new
    local rgb = Color3.fromRGB
    local hex = Color3.fromHex
    local hsv = Color3.fromHSV
    local rgbseq = ColorSequence.new
    local rgbkey = ColorSequenceKeypoint.new
    local numseq = NumberSequence.new
    local numkey = NumberSequenceKeypoint.new

    local camera = ws.CurrentCamera
    local lp = players.LocalPlayer 
    local mouse = lp:GetMouse() 
    local gui_offset = gui_service:GetGuiInset().Y

    local floor = math.floor 
    local min = math.min 
    local max = math.max
    local clamp = math.clamp 

    local insert = table.insert 
    local find = table.find 
    local remove = table.remove
    local concat = table.concat
-- 

-- Library init
    getgenv().library = {
        directory = "avenir",
        project_name = "default",
        folders = {"/fonts", "/configs"},
        flags = {},
        config_flags = {},
        connections = {},
        dependencies = {},
        notifications = {notifs = {}, enabled = false},
        auto_load_config_name = nil,
        notifications_on = false,
        current_open = nil,
        auto_show = true,
        tooltip = nil,
        keybinds = {},
        keybind_list_visible = true,
        keybind_show_all = false,
        watermark_visible = true,
        watermark_elements = {fps = true, ping = true, time = true},
        dpi_scale = 1,
        is_mobile = uis.TouchEnabled and not uis.KeyboardEnabled,
    }

    -- Linoria-style theme colors
    local themes = {
        preset = {
            accent = rgb(0, 85, 255),
            background = rgb(20, 20, 20),
            border = rgb(50, 50, 50),
            darker = rgb(14, 14, 14),
            font = rgb(255, 255, 255),
            font_dark = rgb(130, 130, 130),
            divider = rgb(35, 35, 35),
            section_bg = rgb(25, 25, 25),
            element_bg = rgb(30, 30, 30),
            element_border = rgb(40, 40, 40),
        }, 
        utility = {
            accent = {
                BackgroundColor3 = {},  
                TextColor3 = {}, 
                ImageColor3 = {}, 
            },
        }
    }

    library.__index = library

    local flags = library.flags 
    local config_flags = library.config_flags
    local notifications = library.notifications 

    local fonts = {}
    
    pcall(function()
        local function Register_Font(Name, Weight, Style, Asset)
            if not isfile(Asset.Id) then
                writefile(Asset.Id, Asset.Font)
            end
            if isfile(Name .. ".font") then
                delfile(Name .. ".font")
            end
            local Data = {
                name = Name,
                faces = {{name = "Normal", weight = Weight, style = Style, assetId = getcustomasset(Asset.Id)}}
            }
            writefile(Name .. ".font", http_service:JSONEncode(Data))
            return getcustomasset(Name .. ".font")
        end
        
        local Medium = Register_Font("Medium", 200, "Normal", {
            Id = "Medium.ttf",
            Font = game:HttpGet("https://github.com/i77lhm/storage/raw/refs/heads/main/fonts/Inter_28pt-Medium.ttf"),
        })
        local SemiBold = Register_Font("SemiBold", 200, "Normal", {
            Id = "SemiBold.ttf",
            Font = game:HttpGet("https://github.com/i77lhm/storage/raw/refs/heads/main/fonts/Inter_28pt-SemiBold.ttf"),
        })
        fonts = {
            small = Font.new(Medium, Enum.FontWeight.Regular, Enum.FontStyle.Normal),
            font = Font.new(SemiBold, Enum.FontWeight.Regular, Enum.FontStyle.Normal),
        }
    end)
    
    if not fonts.small then
        fonts.small = Font.fromEnum(Enum.Font.Code)
        fonts.font = Font.fromEnum(Enum.Font.Code)
    end
--

-- DPI Scaling
    function library:scale(value)
        return value * library.dpi_scale
    end

    function library:scale_udim2(x_scale, x_offset, y_scale, y_offset)
        return dim2(x_scale, self:scale(x_offset), y_scale, self:scale(y_offset))
    end

    function library:scale_offset(x, y)
        return dim_offset(self:scale(x), self:scale(y))
    end

    function library:set_dpi(scale)
        library.dpi_scale = scale
        library:save_library_settings()
    end
--

-- Library functions 
    function library:tween(obj, properties, easing_style, time) 
        tween_service:Create(obj, TweenInfo.new(time or 0.2, easing_style or Enum.EasingStyle.Quad, Enum.EasingDirection.Out), properties):Play()
    end

    function library:init_folders()
        pcall(function()
            if not isfolder(library.directory) then makefolder(library.directory) end
            for _, path in next, library.folders do 
                if not isfolder(library.directory .. path) then
                    makefolder(library.directory .. path)
                end
            end
            local project_path = library.directory .. "/configs/" .. library.project_name
            if not isfolder(project_path) then makefolder(project_path) end
        end)
    end

    function library:get_config_path()
        return library.directory .. "/configs/" .. library.project_name
    end

    function library:next_flag()
        local index = 0
        for _ in pairs(library.flags) do index = index + 1 end
        return string.format("flag_%s", index + 1)
    end 

    function library:draggify_simple(frame)
        local dragging = false 
        local start_pos = frame.Position
        local start_input
        
        local function update(input)
            local delta = input.Position - start_input.Position
            local new_pos = dim_offset(
                clamp(start_pos.X.Offset + delta.X, 0, camera.ViewportSize.X - frame.AbsoluteSize.X),
                clamp(start_pos.Y.Offset + delta.Y, 0, camera.ViewportSize.Y - frame.AbsoluteSize.Y)
            )
            frame.Position = new_pos
        end

        frame.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                start_input = input
                start_pos = frame.Position
                
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)

        frame.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                update(input)
            end
        end)
    end

    function library:resizify_simple(frame, min_size, max_size)
        local resizing = false 
        local start_size, start_input
        local og_size = min_size or frame.Size
        local max_s = max_size or dim_offset(500, 500)

        frame.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                local pos = input.Position
                local frame_pos = frame.AbsolutePosition
                local frame_size = frame.AbsoluteSize
                
                if pos.X >= frame_pos.X + frame_size.X - 15 and pos.Y >= frame_pos.Y + frame_size.Y - 15 then
                    resizing = true
                    start_input = input
                    start_size = frame.Size
                    
                    input.Changed:Connect(function()
                        if input.UserInputState == Enum.UserInputState.End then
                            resizing = false
                        end
                    end)
                end
            end
        end)

        frame.InputChanged:Connect(function(input)
            if resizing and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local delta = input.Position - start_input.Position
                local new_size = dim_offset(
                    clamp(start_size.X.Offset + delta.X, og_size.X.Offset, max_s.X.Offset),
                    clamp(start_size.Y.Offset + delta.Y, og_size.Y.Offset, max_s.Y.Offset)
                )
                frame.Size = new_size
            end
        end)
    end

    function library:resizify(frame, min_size) 
        local resize_button = Instance.new("TextButton")
        resize_button.Position = dim2(1, -15, 1, -15)
        resize_button.Size = dim2(0, 15, 0, 15)
        resize_button.BorderSizePixel = 0
        resize_button.BackgroundTransparency = 1
        resize_button.Text = ""
        resize_button.Parent = frame
        resize_button.ZIndex = 10

        -- Resize indicator (corner triangle)
        local resize_icon = Instance.new("Frame")
        resize_icon.Size = dim2(0, 8, 0, 8)
        resize_icon.Position = dim2(1, -10, 1, -10)
        resize_icon.BackgroundColor3 = themes.preset.border
        resize_icon.BorderSizePixel = 0
        resize_icon.Rotation = 45
        resize_icon.Parent = frame
        resize_icon.ZIndex = 10

        local resizing = false 
        local start_size, start
        local og_size = min_size or frame.Size

        resize_button.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                resizing = true
                start = input.Position
                start_size = frame.Size
            end
        end)

        resize_button.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                resizing = false
            end
        end)

        library:connection(uis.InputChanged, function(input) 
            if resizing and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local viewport_x, viewport_y = camera.ViewportSize.X, camera.ViewportSize.Y
                local current_size = dim2(
                    start_size.X.Scale,
                    clamp(start_size.X.Offset + (input.Position.X - start.X), og_size.X.Offset, viewport_x - frame.Position.X.Offset),
                    start_size.Y.Scale,
                    clamp(start_size.Y.Offset + (input.Position.Y - start.Y), og_size.Y.Offset, viewport_y - frame.Position.Y.Offset)
                )
                library:tween(frame, {Size = current_size}, Enum.EasingStyle.Linear, 0.05)
            end
        end)
    end 

    function library:draggify(frame, drag_object)
        local dragging = false 
        local start_size = frame.Position
        local start 
        local drag_target = drag_object or frame

        drag_target.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                start = input.Position
                start_size = frame.Position
            end
        end)

        drag_target.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = false
            end
        end)

        library:connection(uis.InputChanged, function(input) 
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local viewport_x, viewport_y = camera.ViewportSize.X, camera.ViewportSize.Y
                local current_position = dim2(
                    0,
                    clamp(start_size.X.Offset + (input.Position.X - start.X), 0, viewport_x - frame.Size.X.Offset),
                    0,
                    clamp(start_size.Y.Offset + (input.Position.Y - start.Y), 0, viewport_y - frame.Size.Y.Offset)
                )
                library:tween(frame, {Position = current_position}, Enum.EasingStyle.Linear, 0.05)
                library:close_element()
            end
        end)
    end 

    function library:convert_enum(enum)
        local enum_parts = {}
        for part in string.gmatch(enum, "[%w_]+") do
            insert(enum_parts, part)
        end
        local enum_table = Enum
        for i = 2, #enum_parts do
            enum_table = enum_table[enum_parts[i]]
        end
        return enum_table
    end

    function library:get_settings_path()
        return library.directory .. "/configs/" .. library.project_name .. "/settings.json"
    end

    function library:save_library_settings()
        local settings_data = {
            auto_load_config = library.auto_load_config_name,
            notifications_enabled = library.notifications_on,
            keybind_list_visible = library.keybind_list_visible,
            keybind_show_all = library.keybind_show_all,
            watermark_visible = library.watermark_visible,
            watermark_elements = library.watermark_elements,
            dpi_scale = library.dpi_scale,
        }
        pcall(function()
            writefile(library:get_settings_path(), http_service:JSONEncode(settings_data))
        end)
    end

    function library:load_library_settings()
        local path = library:get_settings_path()
        pcall(function()
            if isfile(path) then
                local data = http_service:JSONDecode(readfile(path))
                library.auto_load_config_name = data.auto_load_config
                library.notifications_on = data.notifications_enabled or false
                notifications.enabled = library.notifications_on
                library.keybind_list_visible = data.keybind_list_visible ~= false
                library.keybind_show_all = data.keybind_show_all or false
                library.watermark_visible = data.watermark_visible ~= false
                library.watermark_elements = data.watermark_elements or {fps = true, ping = true, time = true}
                library.dpi_scale = data.dpi_scale or 1
            end
        end)
    end

    function library:set_auto_load(config_name)
        library.auto_load_config_name = config_name
        library:save_library_settings()
    end

    function library:clear_auto_load()
        library.auto_load_config_name = nil
        library:save_library_settings()
    end

    function library:toggle_notifications(enabled)
        library.notifications_on = enabled
        notifications.enabled = enabled
        library:save_library_settings()
    end

    function library:do_auto_load()
        library:load_library_settings()
        if library.auto_load_config_name then
            local config_path = library:get_config_path() .. "/" .. library.auto_load_config_name .. ".cfg"
            pcall(function()
                if isfile(config_path) then
                    task.spawn(function()
                        task.wait(0.5)
                        library:load_config(readfile(config_path))
                        if notifications.enabled then
                            notifications:create_notification({name = "Auto Load", info = "Loaded: " .. library.auto_load_config_name})
                        end
                    end)
                end
            end)
        end
    end

    local config_holder
    function library:update_config_list() 
        if not config_holder then return end
        local list = {}
        pcall(function()
            local config_path = library:get_config_path()
            for _, file in ipairs(listfiles(config_path)) do
                local name = file:match("([^/\\]+)%.cfg$")
                if name then list[#list + 1] = name end
            end
        end)
        if #list == 0 then list = {"No Configs"} end
        config_holder.refresh_options(list)
    end 

    function library:get_config()
        local Config = {}
        for flag, value in pairs(flags) do
            if flag == "config_name_list" or flag == "config_name_text" then continue end
            if type(value) == "table" and value["Transparency"] ~= nil and value["Color"] then
                Config[flag] = {Transparency = value["Transparency"], Color = value["Color"]:ToHex()}
            elseif type(value) == "table" and value["mode"] and value["key"] then
                local key_str = "NONE"
                if value["key"] and tostring(value["key"]) ~= "NONE" and tostring(value["key"]) ~= "Enums" then
                    key_str = tostring(value["key"])
                end
                Config[flag] = {mode = value["mode"], key = key_str, active = value["active"]}
            else
                Config[flag] = value
            end
        end 
        return http_service:JSONEncode(Config)
    end

    function library:load_config(config_json) 
        local success, config = pcall(function()
            return http_service:JSONDecode(config_json)
        end)
        if not success then return end
        for flag, value in pairs(config) do 
            local setter = config_flags[flag]
            if flag == "config_name_list" or flag == "config_name_text" then continue end
            if setter then 
                pcall(function()
                    if type(value) == "table" and value["Transparency"] ~= nil and value["Color"] then
                        setter(hex(value["Color"]), value["Transparency"])
                    elseif type(value) == "table" and value["mode"] and value["key"] then
                        setter(value)
                    else
                        setter(value)
                    end
                end)
            end 
        end 
    end 
    
    function library:round(number, float) 
        local multiplier = 1 / (float or 1)
        return floor(number * multiplier + 0.5) / multiplier
    end 

    function library:apply_theme(instance, theme, property) 
        insert(themes.utility[theme][property], instance)
    end

    function library:update_theme(theme, new_color)
        for property, objects in pairs(themes.utility[theme]) do 
            for _, object in pairs(objects) do 
                pcall(function()
                    if object[property] ~= nil then object[property] = new_color end
                end)
            end 
        end 
        themes.preset[theme] = new_color
        if library.keybind_list_items and library.keybind_list_items["accent_line"] then
            library.keybind_list_items["accent_line"].BackgroundColor3 = new_color
        end
        if library.watermark_items and library.watermark_items["accent_line"] then
            library.watermark_items["accent_line"].BackgroundColor3 = new_color
        end
    end 

    function library:connection(signal, callback)
        local connection = signal:Connect(callback)
        insert(library.connections, connection)
        return connection 
    end

    function library:close_element(new_path) 
        local open_element = library.current_open
        if open_element and new_path ~= open_element then
            pcall(function()
                if open_element.close then
                    open_element.close()
                end
                open_element.open = false
            end)
        end 
        if new_path ~= open_element then 
            library.current_open = new_path or nil
        end
    end 

    function library:create(instance, options)
        local ins = Instance.new(instance) 
        for prop, value in pairs(options) do 
            pcall(function() ins[prop] = value end)
        end
        return ins 
    end

    function library:unload_menu() 
        pcall(function()
            if library["items"] then library["items"]:Destroy() end
            if library["other"] then library["other"]:Destroy() end
            if library["always_on_screen"] then library["always_on_screen"]:Destroy() end
            for _, connection in pairs(library.connections) do 
                connection:Disconnect() 
            end
            library.connections = {}
            library.flags = {}
            library.config_flags = {}
            library.keybinds = {}
        end)
    end 

    function library:get_players()
        local player_list = {}
        for _, player in pairs(players:GetPlayers()) do
            if player ~= lp then insert(player_list, player.Name) end
        end
        if #player_list == 0 then player_list = {"No Players"} end
        return player_list
    end

    function library:add_dependency(element, flag, condition)
        if not library.dependencies[flag] then
            library.dependencies[flag] = {}
        end
        insert(library.dependencies[flag], {element = element, condition = condition})
        local current_value = flags[flag]
        if current_value ~= nil then
            local should_show = condition(current_value)
            if element.items and element.items["toggle"] then
                element.items["toggle"].Visible = should_show
            elseif element.items and element.items["slider_object"] then
                element.items["slider_object"].Visible = should_show
            elseif element.items and element.items["dropdown_object"] then
                element.items["dropdown_object"].Visible = should_show
            end
        end
    end

    function library:update_dependencies(flag, value)
        local deps = library.dependencies[flag]
        if deps then
            for _, dep in pairs(deps) do
                local should_show = dep.condition(value)
                local element = dep.element
                if element.items then
                    for _, item in pairs(element.items) do
                        if typeof(item) == "Instance" then
                            pcall(function() item.Visible = should_show end)
                        end
                    end
                end
            end
        end
    end

    function library:create_tooltip()
        library.tooltip = library:create("Frame", {
            Parent = library["items"],
            Size = dim2(0, 150, 0, 30),
            BackgroundColor3 = themes.preset.background,
            BorderSizePixel = 0,
            Visible = false,
            ZIndex = 200,
        })
        
        library:create("UIStroke", {
            Parent = library.tooltip,
            Color = themes.preset.border,
            Thickness = 1,
        })
        
        library.tooltip_text = library:create("TextLabel", {
            Parent = library.tooltip,
            Size = dim2(1, -8, 1, 0),
            Position = dim2(0, 4, 0, 0),
            BackgroundTransparency = 1,
            TextColor3 = themes.preset.font,
            TextSize = 11,
            FontFace = fonts.small,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextWrapped = true,
            ZIndex = 201,
        })
    end

    function library:show_tooltip(text, element)
        if not library.tooltip then return end
        library.tooltip_text.Text = text
        
        local text_size = game:GetService("TextService"):GetTextSize(text, 11, Enum.Font.Code, Vector2.new(200, 100))
        library.tooltip.Size = dim2(0, text_size.X + 16, 0, text_size.Y + 8)
        
        local mousePos = uis:GetMouseLocation()
        local tooltip_width = text_size.X + 16
        local tooltip_height = text_size.Y + 8
        
        local pos_x = mousePos.X + 10
        local pos_y = mousePos.Y + 10
        
        if pos_x + tooltip_width > camera.ViewportSize.X then
            pos_x = mousePos.X - tooltip_width - 10
        end
        
        if pos_y + tooltip_height > camera.ViewportSize.Y then
            pos_y = mousePos.Y - tooltip_height - 10
        end
        
        library.tooltip.Position = dim_offset(pos_x, pos_y)
        library.tooltip.Visible = true
    end

    function library:hide_tooltip()
        if library.tooltip then
            library.tooltip.Visible = false
        end
    end
--

-- Keybind List (Linoria Style)
    function library:create_keybind_list()
        library["always_on_screen"] = library:create("ScreenGui", {
            Parent = coregui,
            Name = "AvenirAlwaysOn",
            Enabled = true,
            ZIndexBehavior = Enum.ZIndexBehavior.Global,
            IgnoreGuiInset = true,
        })
        
        library.keybind_list_items = {}
        local items = library.keybind_list_items
        
        items["main"] = library:create("Frame", {
            Parent = library["always_on_screen"],
            Position = dim_offset(10, 150),
            Size = dim_offset(180, 28),
            BackgroundColor3 = themes.preset.background,
            BorderSizePixel = 0,
            Visible = library.keybind_list_visible,
            AutomaticSize = Enum.AutomaticSize.Y,
        })
        
        library:create("UIStroke", {
            Parent = items["main"],
            Color = themes.preset.border,
            Thickness = 1,
        })
        
        items["accent_line"] = library:create("Frame", {
            Parent = items["main"],
            Size = dim2(1, 0, 0, 1),
            BackgroundColor3 = themes.preset.accent,
            BorderSizePixel = 0,
        })
        library:apply_theme(items["accent_line"], "accent", "BackgroundColor3")
        
        items["title"] = library:create("TextLabel", {
            Parent = items["main"],
            Position = dim2(0, 8, 0, 4),
            Size = dim2(1, -16, 0, 16),
            BackgroundTransparency = 1,
            Text = "Keybinds",
            TextColor3 = themes.preset.font,
            TextSize = 12,
            FontFace = fonts.font,
            TextXAlignment = Enum.TextXAlignment.Left,
        })
        
        items["divider"] = library:create("Frame", {
            Parent = items["main"],
            Position = dim2(0, 4, 0, 22),
            Size = dim2(1, -8, 0, 1),
            BackgroundColor3 = themes.preset.divider,
            BorderSizePixel = 0,
        })
        
        items["container"] = library:create("Frame", {
            Parent = items["main"],
            Position = dim2(0, 0, 0, 25),
            Size = dim2(1, 0, 0, 0),
            BackgroundTransparency = 1,
            AutomaticSize = Enum.AutomaticSize.Y,
        })
        library:create("UIListLayout", {Parent = items["container"], Padding = dim(0, 2), SortOrder = Enum.SortOrder.LayoutOrder})
        library:create("UIPadding", {Parent = items["container"], PaddingLeft = dim(0, 8), PaddingRight = dim(0, 8), PaddingBottom = dim(0, 6)})
        
        items["keybind_entries"] = {}
        
        library:draggify_simple(items["main"])
    end

    function library:create_watermark(window_name)
        library.watermark_items = {}
        local items = library.watermark_items
        
        items["main"] = library:create("Frame", {
            Parent = library["always_on_screen"],
            Position = dim_offset(10, 10),
            Size = dim_offset(180, 22),
            BackgroundColor3 = themes.preset.background,
            BorderSizePixel = 0,
            Visible = library.watermark_visible,
        })
        
        library:create("UIStroke", {
            Parent = items["main"],
            Color = themes.preset.border,
            Thickness = 1,
        })
        
        items["accent_line"] = library:create("Frame", {
            Parent = items["main"],
            Size = dim2(1, 0, 0, 1),
            BackgroundColor3 = themes.preset.accent,
            BorderSizePixel = 0,
        })
        library:apply_theme(items["accent_line"], "accent", "BackgroundColor3")
        
        items["text"] = library:create("TextLabel", {
            Parent = items["main"],
            Position = dim2(0, 8, 0, 3),
            Size = dim2(1, -16, 1, -3),
            BackgroundTransparency = 1,
            Text = window_name or "avenir",
            TextColor3 = themes.preset.font,
            TextSize = 12,
            FontFace = fonts.font,
            TextXAlignment = Enum.TextXAlignment.Left,
            AutomaticSize = Enum.AutomaticSize.X,
        })
        
        library:draggify_simple(items["main"])
        library:resizify_simple(items["main"], dim_offset(100, 22), dim_offset(400, 22))
        
        library:start_watermark_updates(window_name)
    end

    function library:register_keybind(name, flag, key, mode)
        local keys_map = {
            [Enum.KeyCode.LeftShift] = "LS", [Enum.KeyCode.RightShift] = "RS",
            [Enum.KeyCode.LeftControl] = "LC", [Enum.KeyCode.RightControl] = "RC",
            [Enum.KeyCode.Insert] = "INS", [Enum.KeyCode.Backspace] = "BS",
            [Enum.KeyCode.Return] = "Ent", [Enum.KeyCode.LeftAlt] = "LA",
            [Enum.KeyCode.RightAlt] = "RA", [Enum.KeyCode.CapsLock] = "CAPS",
            [Enum.UserInputType.MouseButton1] = "MB1",
            [Enum.UserInputType.MouseButton2] = "MB2",
            [Enum.UserInputType.MouseButton3] = "MB3",
            [Enum.KeyCode.Escape] = "ESC", [Enum.KeyCode.Space] = "SPC",
        }
        
        local key_text = "None"
        if key and tostring(key) ~= "Enums" and key ~= "NONE" then
            key_text = keys_map[key] or tostring(key):gsub("Enum.KeyCode.", ""):gsub("Enum.UserInputType.", "")
        end
        
        library.keybinds[flag] = {
            name = name,
            key = key,
            key_text = key_text,
            mode = mode,
            active = false,
        }
        
        library:update_keybind_list()
    end

    function library:update_keybind_mode(flag, mode)
        if library.keybinds[flag] then
            library.keybinds[flag].mode = mode
            library:update_keybind_list()
        end
    end

    function library:update_keybind_list()
        if not library.keybind_list_items or not library.keybind_list_items["container"] then return end
        
        local items = library.keybind_list_items
        
        for _, entry in pairs(items["keybind_entries"]) do
            entry:Destroy()
        end
        items["keybind_entries"] = {}
        
        local has_entries = false
        
        for flag, data in pairs(library.keybinds) do
            local should_show = library.keybind_show_all or data.active
            
            if should_show and data.key and data.key ~= "NONE" then
                has_entries = true
                
                local entry = library:create("Frame", {
                    Parent = items["container"],
                    Size = dim2(1, 0, 0, 14),
                    BackgroundTransparency = 1,
                })
                
                library:create("TextLabel", {
                    Parent = entry,
                    Size = dim2(0.6, 0, 1, 0),
                    BackgroundTransparency = 1,
                    Text = data.name,
                    TextColor3 = data.active and themes.preset.font or themes.preset.font_dark,
                    TextSize = 11,
                    FontFace = fonts.small,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    TextTruncate = Enum.TextTruncate.AtEnd,
                })
                
                library:create("TextLabel", {
                    Parent = entry,
                    Size = dim2(0.4, 0, 1, 0),
                    Position = dim2(0.6, 0, 0, 0),
                    BackgroundTransparency = 1,
                    Text = string.format("[%s]", data.key_text),
                    TextColor3 = data.active and themes.preset.accent or themes.preset.font_dark,
                    TextSize = 11,
                    FontFace = fonts.small,
                    TextXAlignment = Enum.TextXAlignment.Right,
                })
                
                insert(items["keybind_entries"], entry)
            end
        end
        
        if not has_entries then
            local empty = library:create("TextLabel", {
                Parent = items["container"],
                Size = dim2(1, 0, 0, 14),
                BackgroundTransparency = 1,
                Text = "No active keybinds",
                TextColor3 = themes.preset.font_dark,
                TextSize = 11,
                FontFace = fonts.small,
                TextXAlignment = Enum.TextXAlignment.Left,
            })
            insert(items["keybind_entries"], empty)
        end
    end

    function library:set_keybind_active(flag, active)
        if library.keybinds[flag] then
            library.keybinds[flag].active = active
            library:update_keybind_list()
        end
    end

    function library:toggle_keybind_list(visible)
        library.keybind_list_visible = visible
        if library.keybind_list_items and library.keybind_list_items["main"] then
            library.keybind_list_items["main"].Visible = visible
        end
        library:save_library_settings()
    end

    function library:set_keybind_show_all(show_all)
        library.keybind_show_all = show_all
        library:update_keybind_list()
        library:save_library_settings()
    end
--

-- Watermark
    function library:start_watermark_updates(window_name)
        local last_fps_update = 0
        local fps_value = 0
        local frame_count = 0
        
        library:connection(run.RenderStepped, function(dt)
            if not library.watermark_items or not library.watermark_items["text"] then return end
            if not library.watermark_visible then return end
            
            frame_count = frame_count + 1
            last_fps_update = last_fps_update + dt
            
            if last_fps_update >= 0.5 then
                fps_value = floor(frame_count / last_fps_update)
                frame_count = 0
                last_fps_update = 0
            end
            
            local parts = {window_name or "avenir"}
            
            if library.watermark_elements.fps then
                insert(parts, fps_value .. " fps")
            end
            
            if library.watermark_elements.ping then
                local ping = floor(stats_service.Network.ServerStatsItem["Data Ping"]:GetValue())
                insert(parts, ping .. " ms")
            end
            
            if library.watermark_elements.time then
                insert(parts, os.date("%H:%M:%S"))
            end
            
            library.watermark_items["text"].Text = concat(parts, " | ")
            
            local text_size = game:GetService("TextService"):GetTextSize(
                library.watermark_items["text"].Text, 
                12, 
                Enum.Font.Code, 
                Vector2.new(1000, 22)
            )
            library.watermark_items["main"].Size = dim_offset(text_size.X + 20, 22)
        end)
    end

    function library:toggle_watermark(visible)
        library.watermark_visible = visible
        if library.watermark_items and library.watermark_items["main"] then
            library.watermark_items["main"].Visible = visible
        end
        library:save_library_settings()
    end

    function library:set_watermark_element(element, visible)
        library.watermark_elements[element] = visible
        library:save_library_settings()
    end
--

-- Mobile Support
    function library:create_mobile_toggle()
        if not library.is_mobile then return end
        
        local toggle_btn = library:create("TextButton", {
            Parent = library["always_on_screen"],
            Position = dim_offset(10, camera.ViewportSize.Y - 60),
            Size = dim_offset(44, 44),
            BackgroundColor3 = themes.preset.background,
            Text = "â˜°",
            TextColor3 = themes.preset.font,
            TextSize = 20,
            Font = Enum.Font.Code,
            AutoButtonColor = false,
        })
        
        library:create("UIStroke", {
            Parent = toggle_btn,
            Color = themes.preset.accent,
            Thickness = 1,
        })
        
        toggle_btn.MouseButton1Click:Connect(function()
            library["items"].Enabled = not library["items"].Enabled
        end)
    end
--

-- Window (Linoria Style)
    function library:window(properties)
        local cfg = { 
            suffix = properties.suffix or "",
            name = properties.name or "Avenir",
            game_name = properties.gameInfo or "Avenir UI",
            size = properties.size or dim2(0, 550, 0, 600),
            selected_tab = nil,
            items = {},
        }
        
        library.project_name = properties.project or properties.name or "default"
        library.auto_show = properties.auto_show ~= false
        library:init_folders()
        library:load_library_settings()
        
        library["items"] = library:create("ScreenGui", {
            Parent = coregui,
            Name = "AvenirUI",
            Enabled = library.auto_show,
            ZIndexBehavior = Enum.ZIndexBehavior.Global,
            IgnoreGuiInset = true,
        })
        
        library["other"] = library:create("ScreenGui", {
            Parent = coregui,
            Name = "AvenirOther",
            Enabled = true,
            ZIndexBehavior = Enum.ZIndexBehavior.Global,
            IgnoreGuiInset = true,
        })

        local items = cfg.items
        local scale = library.dpi_scale
        
        -- Main container with Linoria style
        items["main"] = library:create("Frame", {
            Parent = library["items"],
            Size = dim_offset(cfg.size.X.Offset * scale, cfg.size.Y.Offset * scale),
            Position = dim2(0.5, -(cfg.size.X.Offset * scale) / 2, 0.5, -(cfg.size.Y.Offset * scale) / 2),
            BorderSizePixel = 0,
            BackgroundColor3 = themes.preset.background
        })
        items["main"].Position = dim2(0, items["main"].AbsolutePosition.X, 0, items["main"].AbsolutePosition.Y)
        
        -- Outer border stroke
        library:create("UIStroke", {
            Color = themes.preset.border, 
            Parent = items["main"], 
            Thickness = 1, 
            ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        })
        
        -- Accent line at top
        items["accent_top"] = library:create("Frame", {
            Parent = items["main"],
            Size = dim2(1, 0, 0, 1),
            BackgroundColor3 = themes.preset.accent,
            BorderSizePixel = 0,
        })
        library:apply_theme(items["accent_top"], "accent", "BackgroundColor3")
        
        -- Title bar
        items["top_bar"] = library:create("Frame", {
            Parent = items["main"],
            Position = dim2(0, 0, 0, 1),
            Size = dim2(1, 0, 0, library:scale(28)),
            BorderSizePixel = 0,
            BackgroundColor3 = themes.preset.darker
        })
        
        items["title"] = library:create("TextLabel", {
            FontFace = fonts.font,
            Parent = items["top_bar"],
            Text = cfg.name .. cfg.suffix,
            Position = dim2(0, library:scale(10), 0.5, 0),
            AnchorPoint = vec2(0, 0.5),
            BackgroundTransparency = 1,
            TextColor3 = themes.preset.font,
            AutomaticSize = Enum.AutomaticSize.XY,
            TextSize = library:scale(13),
            TextXAlignment = Enum.TextXAlignment.Left,
        })
        
        -- Tab holder (left side, vertical like Linoria)
        items["tab_container"] = library:create("Frame", {
            Parent = items["main"],
            Position = dim2(0, 0, 0, library:scale(29)),
            Size = dim2(0, library:scale(120), 1, library:scale(-29)),
            BorderSizePixel = 0,
            BackgroundColor3 = themes.preset.darker
        })
        
        -- Divider between tabs and content
        items["tab_divider"] = library:create("Frame", {
            Parent = items["tab_container"],
            Position = dim2(1, -1, 0, 0),
            Size = dim2(0, 1, 1, 0),
            BorderSizePixel = 0,
            BackgroundColor3 = themes.preset.border
        })
        
        items["tab_holder"] = library:create("ScrollingFrame", {
            Parent = items["tab_container"],
            Position = dim2(0, 0, 0, library:scale(4)),
            Size = dim2(1, -2, 1, library:scale(-8)),
            BackgroundTransparency = 1,
            ScrollBarThickness = 0,
            CanvasSize = dim2(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            BorderSizePixel = 0,
        })
        library:create("UIListLayout", {Parent = items["tab_holder"], Padding = dim(0, 2), SortOrder = Enum.SortOrder.LayoutOrder})
        library:create("UIPadding", {Parent = items["tab_holder"], PaddingLeft = dim(0, 6), PaddingRight = dim(0, 6), PaddingTop = dim(0, 2)})
        
        -- Content area
        items["content_area"] = library:create("Frame", {
            Parent = items["main"],
            Position = dim2(0, library:scale(120), 0, library:scale(29)),
            Size = dim2(1, library:scale(-120), 1, library:scale(-29)),
            BorderSizePixel = 0,
            BackgroundTransparency = 1,
        })
        
        items["global_fade"] = library:create("Frame", {
            Parent = items["content_area"],
            BackgroundTransparency = 1,
            Position = dim2(0, 0, 0, 0),
            Size = dim2(1, 0, 1, 0),
            BorderSizePixel = 0,
            BackgroundColor3 = themes.preset.background,
            ZIndex = 2,
        })

        library:draggify(items["main"], items["top_bar"])
        library:resizify(items["main"], dim2(0, 450, 0, 400))
        library:create_tooltip()
        library:create_keybind_list()
        library:create_watermark(cfg.name .. cfg.suffix)
        library:create_mobile_toggle()

        function cfg.toggle_menu(bool) 
            library["items"].Enabled = bool
        end 
            
        return setmetatable(cfg, library)
    end 
--

-- Tab (Linoria Style - Vertical tabs with groupbox layout)
    function library:tab(properties)
        local cfg = {
            name = properties.name or "Tab", 
            icon = properties.icon or nil,
            tabs = properties.tabs or {"Main"},
            pages = {},
            current_multi = nil, 
            items = {},
        } 

        local items = cfg.items
        
        -- Tab button (Linoria style - full width, left aligned)
        items["button"] = library:create("TextButton", {
            FontFace = fonts.font,
            Text = "",
            Parent = self.items["tab_holder"],
            AutoButtonColor = false,
            BackgroundColor3 = themes.preset.background,
            BackgroundTransparency = 1,
            Size = dim2(1, 0, 0, library:scale(26)),
            TextSize = library:scale(12),
        })
        
        items["button_bg"] = library:create("Frame", {
            Parent = items["button"],
            Size = dim2(1, 0, 1, 0),
            BackgroundColor3 = themes.preset.element_bg,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
        })
        
        if cfg.icon then
            items["icon"] = library:create("ImageLabel", {
                ImageColor3 = themes.preset.font_dark,
                Parent = items["button"],
                AnchorPoint = vec2(0, 0.5),
                Image = cfg.icon,
                BackgroundTransparency = 1,
                Position = dim2(0, library:scale(6), 0.5, 0),
                Size = dim_offset(library:scale(14), library:scale(14)),
            })
        end
        
        items["name"] = library:create("TextLabel", {
            FontFace = fonts.font,
            TextColor3 = themes.preset.font_dark,
            Text = cfg.name,
            Parent = items["button"],
            Position = dim2(0, cfg.icon and library:scale(24) or library:scale(8), 0, 0),
            Size = dim2(1, cfg.icon and -24 or -8, 1, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = library:scale(12),
        })
        
        items["accent_line"] = library:create("Frame", {
            Parent = items["button"],
            Position = dim2(0, 0, 0, 0),
            Size = dim2(0, 2, 1, 0),
            BackgroundColor3 = themes.preset.accent,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
        })
        library:apply_theme(items["accent_line"], "accent", "BackgroundColor3")
        
        items["tab_content"] = library:create("Frame", {
            Parent = library["other"],
            Visible = false,
            BackgroundTransparency = 1,
            Size = dim2(1, -8, 1, -8),
            Position = dim2(0, 4, 0, 4),
        })

        -- For tabs with sub-tabs (groupbox containers)
        for i, section in ipairs(cfg.tabs) do
            local data = {items = {}} 
            local sub_items = data.items
            
            sub_items["page"] = library:create("Frame", {
                Parent = library["other"],
                BackgroundTransparency = 1,
                Size = dim2(1, 0, 1, 0),
                Visible = false,
            })
            
            library:create("UIListLayout", {
                FillDirection = Enum.FillDirection.Horizontal, 
                HorizontalFlex = Enum.UIFlexAlignment.Fill, 
                Parent = sub_items["page"], 
                Padding = dim(0, 8), 
                SortOrder = Enum.SortOrder.LayoutOrder, 
                VerticalFlex = Enum.UIFlexAlignment.Fill
            })
            library:create("UIPadding", {PaddingTop = dim(0, 4), PaddingBottom = dim(0, 4), PaddingLeft = dim(0, 4), PaddingRight = dim(0, 4), Parent = sub_items["page"]})

            data.text = nil
            data.button = nil
            data.page = sub_items["page"]
            
            local sub = setmetatable(data, library):sub_tab({})
            data.parent = sub.items["tab_parent"]

            function data.open_page()
                local page = cfg.current_multi
                if page and page ~= data then 
                    self.items["global_fade"].BackgroundTransparency = 0
                    library:tween(self.items["global_fade"], {BackgroundTransparency = 1}, Enum.EasingStyle.Quad, 0.2)
                    page.page.Visible = false
                    page.page.Parent = library["other"] 
                end 
                data.page.Visible = true
                data.page.Parent = items["tab_content"]
                cfg.current_multi = data
                library:close_element()
            end

            cfg.pages[#cfg.pages + 1] = setmetatable(data, library)
        end 

        cfg.pages[1].open_page()

        function cfg.open_tab() 
            local selected_tab = self.selected_tab
            if selected_tab then 
                if selected_tab[4] ~= items["tab_content"] then 
                    self.items["global_fade"].BackgroundTransparency = 0
                    library:tween(self.items["global_fade"], {BackgroundTransparency = 1}, Enum.EasingStyle.Quad, 0.2)
                end
                library:tween(selected_tab[1], {BackgroundTransparency = 1})
                if selected_tab[2] then
                    library:tween(selected_tab[2], {ImageColor3 = themes.preset.font_dark})
                end
                library:tween(selected_tab[3], {TextColor3 = themes.preset.font_dark})
                library:tween(selected_tab[5], {BackgroundTransparency = 1})
                selected_tab[4].Visible = false
                selected_tab[4].Parent = library["other"]
            end
            library:tween(items["button_bg"], {BackgroundTransparency = 0.9})
            if items["icon"] then
                library:tween(items["icon"], {ImageColor3 = themes.preset.font})
            end
            library:tween(items["name"], {TextColor3 = themes.preset.font})
            library:tween(items["accent_line"], {BackgroundTransparency = 0})
            items["tab_content"].Visible = true 
            items["tab_content"].Parent = self.items["content_area"]
            self.selected_tab = {items["button_bg"], items["icon"], items["name"], items["tab_content"], items["accent_line"]}
            library:close_element()
        end

        items["button"].MouseButton1Down:Connect(function()
            cfg.open_tab()
        end)
        
        items["button"].MouseEnter:Connect(function()
            if self.selected_tab and self.selected_tab[1] == items["button_bg"] then return end
            library:tween(items["button_bg"], {BackgroundTransparency = 0.95})
        end)
        
        items["button"].MouseLeave:Connect(function()
            if self.selected_tab and self.selected_tab[1] == items["button_bg"] then return end
            library:tween(items["button_bg"], {BackgroundTransparency = 1})
        end)
        
        if not self.selected_tab then cfg.open_tab() end

        return unpack(cfg.pages)
    end

    function library:seperator(properties)
        local cfg = {items = {}}
        cfg.items["separator"] = library:create("Frame", {
            Parent = self.items["tab_holder"],
            Size = dim2(1, 0, 0, 1),
            BackgroundColor3 = themes.preset.divider,
        })
        library:create("UIPadding", {Parent = cfg.items["separator"], PaddingTop = dim(0, 4), PaddingBottom = dim(0, 4)})
        return setmetatable(cfg, library)
    end 

    function library:column(properties) 
        local cfg = {items = {}, size = properties.size or 1}
        cfg.items["column"] = library:create("Frame", {
            Parent = self["parent"] or self.items["tab_parent"],
            BackgroundTransparency = 1,
            Size = dim2(0, 0, cfg.size, 0),
        })
        library:create("UIPadding", {PaddingBottom = dim(0, 4), Parent = cfg.items["column"]})
        library:create("UIListLayout", {Parent = cfg.items["column"], HorizontalFlex = Enum.UIFlexAlignment.Fill, Padding = dim(0, 8), FillDirection = Enum.FillDirection.Vertical, SortOrder = Enum.SortOrder.LayoutOrder})
        return setmetatable(cfg, library)
    end 

    function library:sub_tab(properties) 
        local cfg = {items = {}, size = properties.size or 1}
        cfg.items["tab_parent"] = library:create("Frame", {
            Parent = self.items["page"],
            BackgroundTransparency = 1,
            Size = dim2(0, 0, cfg.size, 0),
            Visible = true,
        })
        library:create("UIListLayout", {FillDirection = Enum.FillDirection.Horizontal, HorizontalFlex = Enum.UIFlexAlignment.Fill, VerticalFlex = Enum.UIFlexAlignment.Fill, Parent = cfg.items["tab_parent"], Padding = dim(0, 8), SortOrder = Enum.SortOrder.LayoutOrder})
        return setmetatable(cfg, library)
    end 
--

-- Section (Linoria Groupbox Style)
    function library:section(properties)
        local cfg = {
            name = properties.name or "Groupbox", 
            size = properties.size or 0.5, 
            icon = properties.icon,
            items = {},
        }
        
        local items = cfg.items
        
        -- Groupbox container
        items["outline"] = library:create("Frame", {
            Parent = self.items["column"],
            Size = dim2(0, 0, cfg.size, -4),
            BackgroundColor3 = themes.preset.section_bg,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Color = themes.preset.border, 
            Parent = items["outline"], 
            Thickness = 1
        })
        
        -- Header with title
        items["header"] = library:create("Frame", {
            Parent = items["outline"],
            Size = dim2(1, 0, 0, library:scale(22)),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
        })
        
        items["section_title"] = library:create("TextLabel", {
            FontFace = fonts.font,
            TextColor3 = themes.preset.font,
            Text = cfg.name,
            Parent = items["header"],
            Position = dim2(0, library:scale(10), 0, 0),
            Size = dim2(1, library:scale(-20), 1, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = library:scale(12),
        })
        
        -- Divider under header
        items["divider"] = library:create("Frame", {
            Parent = items["outline"],
            Position = dim2(0, 8, 0, library:scale(22)),
            Size = dim2(1, -16, 0, 1),
            BackgroundColor3 = themes.preset.divider,
            BorderSizePixel = 0,
        })
        
        items["scrolling"] = library:create("ScrollingFrame", {
            ScrollBarImageColor3 = themes.preset.border,
            Active = true,
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            ScrollBarThickness = 2,
            Parent = items["outline"],
            Size = dim2(1, 0, 1, library:scale(-26)),
            BackgroundTransparency = 1,
            Position = dim2(0, 0, 0, library:scale(26)),
            CanvasSize = dim2(0, 0, 0, 0),
            BorderSizePixel = 0,
        })
        
        items["elements"] = library:create("Frame", {
            Parent = items["scrolling"],
            BackgroundTransparency = 1,
            Position = dim2(0, 10, 0, 4),
            Size = dim2(1, -20, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
        })
        library:create("UIListLayout", {Parent = items["elements"], Padding = dim(0, library:scale(6)), SortOrder = Enum.SortOrder.LayoutOrder})
        library:create("UIPadding", {PaddingBottom = dim(0, 8), Parent = items["elements"]})

        return setmetatable(cfg, library)
    end  
--

-- Tab Box (Linoria Style)
    function library:tabbox(properties)
        local cfg = {
            tabs = properties.tabs or {"Tab 1", "Tab 2"},
            current_tab = nil,
            tab_data = {},
            items = {},
        }
        
        local items = cfg.items
        
        items["tabbox"] = library:create("Frame", {
            Parent = self.items["elements"],
            Size = dim2(1, 0, 0, 0),
            BackgroundColor3 = themes.preset.darker,
            AutomaticSize = Enum.AutomaticSize.Y,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Color = themes.preset.border,
            Parent = items["tabbox"],
            Thickness = 1,
        })
        
        items["tab_buttons"] = library:create("Frame", {
            Parent = items["tabbox"],
            Size = dim2(1, 0, 0, library:scale(24)),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
        })
        library:create("UIListLayout", {Parent = items["tab_buttons"], FillDirection = Enum.FillDirection.Horizontal, SortOrder = Enum.SortOrder.LayoutOrder})
        
        items["tab_divider"] = library:create("Frame", {
            Parent = items["tabbox"],
            Position = dim2(0, 0, 0, library:scale(24)),
            Size = dim2(1, 0, 0, 1),
            BackgroundColor3 = themes.preset.border,
            BorderSizePixel = 0,
        })
        
        items["content"] = library:create("Frame", {
            Parent = items["tabbox"],
            Position = dim2(0, 0, 0, library:scale(25)),
            Size = dim2(1, 0, 0, 0),
            BackgroundTransparency = 1,
            AutomaticSize = Enum.AutomaticSize.Y,
        })
        
        for i, tab_name in ipairs(cfg.tabs) do
            local tab = {}
            
            tab.button = library:create("TextButton", {
                Parent = items["tab_buttons"],
                Size = dim2(1 / #cfg.tabs, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = tab_name,
                TextColor3 = themes.preset.font_dark,
                TextSize = library:scale(11),
                FontFace = fonts.font,
                AutoButtonColor = false,
            })
            
            tab.accent = library:create("Frame", {
                Parent = tab.button,
                Position = dim2(0, 0, 1, -1),
                Size = dim2(1, 0, 0, 1),
                BackgroundColor3 = themes.preset.accent,
                BackgroundTransparency = 1,
                BorderSizePixel = 0,
            })
            library:apply_theme(tab.accent, "accent", "BackgroundColor3")
            
            tab.page = library:create("Frame", {
                Parent = items["content"],
                Size = dim2(1, 0, 0, 0),
                BackgroundTransparency = 1,
                Visible = false,
                AutomaticSize = Enum.AutomaticSize.Y,
            })
            
            tab.elements = library:create("Frame", {
                Parent = tab.page,
                Size = dim2(1, -12, 0, 0),
                Position = dim2(0, 6, 0, 4),
                BackgroundTransparency = 1,
                AutomaticSize = Enum.AutomaticSize.Y,
            })
            library:create("UIListLayout", {Parent = tab.elements, Padding = dim(0, library:scale(6)), SortOrder = Enum.SortOrder.LayoutOrder})
            library:create("UIPadding", {Parent = tab.elements, PaddingBottom = dim(0, 6)})
            
            tab.button.MouseButton1Click:Connect(function()
                if cfg.current_tab then
                    cfg.current_tab.page.Visible = false
                    library:tween(cfg.current_tab.button, {TextColor3 = themes.preset.font_dark})
                    library:tween(cfg.current_tab.accent, {BackgroundTransparency = 1})
                end
                tab.page.Visible = true
                library:tween(tab.button, {TextColor3 = themes.preset.font})
                library:tween(tab.accent, {BackgroundTransparency = 0})
                cfg.current_tab = tab
            end)
            
            cfg.tab_data[tab_name] = {items = {elements = tab.elements}}
            
            if i == 1 then
                tab.page.Visible = true
                tab.button.TextColor3 = themes.preset.font
                tab.accent.BackgroundTransparency = 0
                cfg.current_tab = tab
            end
        end
        
        function cfg.get_tab(name)
            return setmetatable(cfg.tab_data[name], library)
        end
        
        return cfg
    end
--

-- Label (Linoria Style)
    function library:label(options)
        local cfg = {
            name = options.name or "Label",
            items = {},
        }
        
        cfg.items["label"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font_dark,
            Text = cfg.name,
            Parent = self.items["elements"],
            Size = dim2(1, 0, 0, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            AutomaticSize = Enum.AutomaticSize.Y,
            TextSize = library:scale(12),
        })
        
        function cfg.set_text(text)
            cfg.items["label"].Text = text
        end
        
        return setmetatable(cfg, library)
    end
--

-- Toggle (Linoria Style - Checkbox)
    function library:toggle(options) 
        local cfg = {
            name = options.name or "Toggle",
            flag = options.flag or library:next_flag(),
            default = options.default or false,
            callback = options.callback or function() end,
            tooltip = options.tooltip,
            items = {},
            enabled = options.default or false,
        }

        flags[cfg.flag] = cfg.default
        local items = cfg.items
        
        items["toggle"] = library:create("TextButton", {
            FontFace = fonts.small,
            Text = "",
            Parent = self.items["elements"],
            BackgroundTransparency = 1,
            Size = dim2(1, 0, 0, library:scale(18)),
            TextSize = library:scale(12),
        })
        
        -- Checkbox (Linoria style - square)
        items["checkbox"] = library:create("Frame", {
            Parent = items["toggle"],
            AnchorPoint = vec2(0, 0.5),
            Position = dim2(0, 0, 0.5, 0),
            Size = dim_offset(library:scale(14), library:scale(14)),
            BackgroundColor3 = themes.preset.element_bg,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["checkbox"],
            Color = themes.preset.element_border,
            Thickness = 1,
        })
        
        items["checkmark"] = library:create("TextLabel", {
            Parent = items["checkbox"],
            Size = dim2(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = "âœ“",
            TextColor3 = themes.preset.font,
            TextSize = library:scale(10),
            FontFace = fonts.font,
            TextTransparency = 1,
        })
        
        items["name"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font,
            Text = cfg.name,
            Parent = items["toggle"],
            Position = dim2(0, library:scale(20), 0, 0),
            Size = dim2(1, -20, 1, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = library:scale(12),
        })
        
        function cfg.set(bool)
            cfg.enabled = bool
            
            local stroke = items["checkbox"]:FindFirstChildOfClass("UIStroke")
            if bool then
                library:tween(items["checkbox"], {BackgroundColor3 = themes.preset.accent})
                library:tween(stroke, {Color = themes.preset.accent})
                library:tween(items["checkmark"], {TextTransparency = 0})
            else
                library:tween(items["checkbox"], {BackgroundColor3 = themes.preset.element_bg})
                library:tween(stroke, {Color = themes.preset.element_border})
                library:tween(items["checkmark"], {TextTransparency = 1})
            end
            
            flags[cfg.flag] = bool
            cfg.callback(bool)
            library:update_dependencies(cfg.flag, bool)
        end 
        
        items["toggle"].MouseButton1Click:Connect(function()
            cfg.enabled = not cfg.enabled 
            cfg.set(cfg.enabled)
        end)
        
        if cfg.tooltip then
            items["toggle"].MouseEnter:Connect(function()
                library:show_tooltip(cfg.tooltip, items["toggle"])
            end)
            items["toggle"].MouseLeave:Connect(function()
                library:hide_tooltip()
            end)
        end

        cfg.set(cfg.default)
        config_flags[cfg.flag] = cfg.set

        return setmetatable(cfg, library)
    end 
--

-- Slider (Linoria Style)
    function library:slider(options) 
        local cfg = {
            name = options.name or "Slider",
            suffix = options.suffix or "",
            flag = options.flag or library:next_flag(),
            callback = options.callback or function() end, 
            min = options.min or 0,
            max = options.max or 100,
            intervals = options.interval or 1,
            default = options.default or 10,
            tooltip = options.tooltip,
            value = options.default or 10, 
            dragging = false,
            items = {}
        } 

        flags[cfg.flag] = cfg.default
        local items = cfg.items
        
        items["slider_object"] = library:create("Frame", {
            Parent = self.items["elements"],
            BackgroundTransparency = 1,
            Size = dim2(1, 0, 0, library:scale(32)),
        })
        
        items["name"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font,
            Text = cfg.name,
            Parent = items["slider_object"],
            Size = dim2(0.7, 0, 0, library:scale(14)),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = library:scale(12),
        })
        
        items["value"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font_dark,
            Text = "0",
            Parent = items["slider_object"],
            Size = dim2(0.3, 0, 0, library:scale(14)),
            Position = dim2(0.7, 0, 0, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Right,
            TextSize = library:scale(11),
        })
        
        items["slider_bg"] = library:create("Frame", {
            Parent = items["slider_object"],
            Size = dim2(1, 0, 0, library:scale(10)),
            Position = dim2(0, 0, 0, library:scale(18)),
            BackgroundColor3 = themes.preset.element_bg,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["slider_bg"],
            Color = themes.preset.element_border,
            Thickness = 1,
        })
        
        items["slider"] = library:create("TextButton", {
            Text = "",
            AutoButtonColor = false,
            Parent = items["slider_bg"],
            Size = dim2(1, 0, 1, 0),
            BackgroundTransparency = 1,
        })
        
        items["fill"] = library:create("Frame", {
            Parent = items["slider_bg"],
            Size = dim2(0.5, 0, 1, 0),
            BackgroundColor3 = themes.preset.accent,
            BorderSizePixel = 0,
        })
        library:apply_theme(items["fill"], "accent", "BackgroundColor3")

        function cfg.set(value)
            cfg.value = clamp(library:round(value, cfg.intervals), cfg.min, cfg.max)
            local percentage = (cfg.value - cfg.min) / (cfg.max - cfg.min)
            library:tween(items["fill"], {Size = dim2(percentage, 0, 1, 0)}, Enum.EasingStyle.Linear, 0.05)
            items["value"].Text = tostring(cfg.value) .. cfg.suffix
            flags[cfg.flag] = cfg.value
            cfg.callback(cfg.value)
            library:update_dependencies(cfg.flag, cfg.value)
        end

        items["slider"].InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                cfg.dragging = true 
            end
        end)

        library:connection(uis.InputChanged, function(input)
            if cfg.dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then 
                local size_x = (input.Position.X - items["slider_bg"].AbsolutePosition.X) / items["slider_bg"].AbsoluteSize.X
                cfg.set(((cfg.max - cfg.min) * size_x) + cfg.min)
            end
        end)

        library:connection(uis.InputEnded, function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                cfg.dragging = false
            end 
        end)
        
        if cfg.tooltip then
            items["slider_object"].MouseEnter:Connect(function()
                library:show_tooltip(cfg.tooltip, items["slider_object"])
            end)
            items["slider_object"].MouseLeave:Connect(function()
                library:hide_tooltip()
            end)
        end

        cfg.set(cfg.default)
        config_flags[cfg.flag] = cfg.set

        return setmetatable(cfg, library)
    end 
--

-- Dropdown (Linoria Style)
    function library:dropdown(options) 
        local cfg = {
            name = options.name or "Dropdown",
            flag = options.flag or library:next_flag(),
            options = options.items or {"Option 1", "Option 2"},
            callback = options.callback or function() end,
            multi = options.multi or false,
            tooltip = options.tooltip,
            open = false,
            option_instances = {},
            multi_items = {},
            items = {},
            y_size = 0,
        }   

        cfg.default = options.default or (cfg.multi and {cfg.options[1]}) or cfg.options[1] or "None"
        flags[cfg.flag] = cfg.default
        local items = cfg.items
        
        items["dropdown_object"] = library:create("Frame", {
            Parent = self.items["elements"],
            BackgroundTransparency = 1,
            Size = dim2(1, 0, 0, library:scale(36)),
        })
        
        items["name"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font,
            Text = cfg.name,
            Parent = items["dropdown_object"],
            Size = dim2(1, 0, 0, library:scale(14)),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
                        TextSize = library:scale(12),
        })
        
        items["dropdown"] = library:create("TextButton", {
            Text = "",
            AutoButtonColor = false,
            Parent = items["dropdown_object"],
            Position = dim2(0, 0, 0, library:scale(16)),
            Size = dim2(1, 0, 0, library:scale(20)),
            BackgroundColor3 = themes.preset.element_bg,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["dropdown"],
            Color = themes.preset.element_border,
            Thickness = 1,
        })
        
        items["sub_text"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font,
            Text = "",
            Parent = items["dropdown"],
            Size = dim2(1, -24, 1, 0),
            Position = dim2(0, 8, 0, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd,
            TextSize = library:scale(11),
        })
        
        items["arrow"] = library:create("TextLabel", {
            FontFace = fonts.font,
            TextColor3 = themes.preset.font_dark,
            Text = "â–¾",
            Parent = items["dropdown"],
            AnchorPoint = vec2(1, 0.5),
            Position = dim2(1, -8, 0.5, 0),
            BackgroundTransparency = 1,
            AutomaticSize = Enum.AutomaticSize.XY,
            TextSize = library:scale(12),
        })

        items["dropdown_holder"] = library:create("Frame", {
            Parent = items["dropdown_object"],
            Visible = false,
            Position = dim2(0, 0, 0, library:scale(37)),
            Size = dim2(1, 0, 0, 0),
            BackgroundColor3 = themes.preset.element_bg,
            ClipsDescendants = true,
            ZIndex = 50,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["dropdown_holder"],
            Color = themes.preset.element_border,
            Thickness = 1,
        })
        
        items["scroll_frame"] = library:create("ScrollingFrame", {
            Parent = items["dropdown_holder"],
            Size = dim2(1, 0, 1, 0),
            BackgroundTransparency = 1,
            ScrollBarThickness = 2,
            ScrollBarImageColor3 = themes.preset.border,
            CanvasSize = dim2(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            BorderSizePixel = 0,
            ZIndex = 50,
        })
        
        items["option_list"] = library:create("Frame", {
            Parent = items["scroll_frame"],
            Size = dim2(1, 0, 0, 0),
            BackgroundTransparency = 1,
            AutomaticSize = Enum.AutomaticSize.Y,
        })
        library:create("UIListLayout", {Parent = items["option_list"], Padding = dim(0, 0), SortOrder = Enum.SortOrder.LayoutOrder})
        library:create("UIPadding", {Parent = items["option_list"], PaddingTop = dim(0, 2), PaddingBottom = dim(0, 2)})

        function cfg.render_option(text)
            local button = library:create("TextButton", {
                FontFace = fonts.small,
                TextColor3 = themes.preset.font_dark,
                Text = text,
                Parent = items["option_list"],
                Size = dim2(1, 0, 0, library:scale(18)),
                BackgroundTransparency = 1,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextSize = library:scale(11),
                ZIndex = 51,
                AutoButtonColor = false,
            })
            library:create("UIPadding", {Parent = button, PaddingLeft = dim(0, 8)})
            
            button.MouseEnter:Connect(function()
                if not find(cfg.multi_items, text) then
                    library:tween(button, {TextColor3 = themes.preset.font})
                end
            end)
            
            button.MouseLeave:Connect(function()
                if not find(cfg.multi_items, text) then
                    library:tween(button, {TextColor3 = themes.preset.font_dark})
                end
            end)
            
            return button
        end
        
        function cfg.close()
            cfg.open = false
            library:tween(items["dropdown_holder"], {Size = dim2(1, 0, 0, 0)}, Enum.EasingStyle.Quad, 0.15)
            library:tween(items["arrow"], {Rotation = 0}, Enum.EasingStyle.Quad, 0.1)
            task.delay(0.15, function()
                if not cfg.open then
                    items["dropdown_holder"].Visible = false
                end
            end)
        end
        
        function cfg.set_visible(bool)
            if bool then
                items["dropdown_holder"].Visible = true
                local target_height = min(cfg.y_size, library:scale(120))
                library:tween(items["dropdown_holder"], {Size = dim2(1, 0, 0, target_height)}, Enum.EasingStyle.Quad, 0.15)
                library:tween(items["arrow"], {Rotation = 180}, Enum.EasingStyle.Quad, 0.1)
                library.current_open = cfg
            else
                cfg.close()
            end
        end
        
        function cfg.set(value)
            local selected = {}
            local isTable = type(value) == "table"
            for _, option in pairs(cfg.option_instances) do 
                if option.Text == value or (isTable and find(value, option.Text)) then 
                    insert(selected, option.Text)
                    cfg.multi_items = selected
                    option.TextColor3 = themes.preset.accent
                else
                    option.TextColor3 = themes.preset.font_dark
                end
            end
            items["sub_text"].Text = isTable and concat(selected, ", ") or selected[1] or ""
            flags[cfg.flag] = isTable and selected or selected[1]
            cfg.callback(flags[cfg.flag])
            library:update_dependencies(cfg.flag, flags[cfg.flag])
        end
        
        function cfg.refresh_options(list) 
            cfg.y_size = 4
            for _, option in pairs(cfg.option_instances) do option:Destroy() end
            cfg.option_instances = {} 
            for _, option in ipairs(list) do 
                local button = cfg.render_option(option)
                cfg.y_size = cfg.y_size + library:scale(18)
                insert(cfg.option_instances, button)
                button.MouseButton1Click:Connect(function()
                    if cfg.multi then 
                        local selected_index = find(cfg.multi_items, button.Text)
                        if selected_index then remove(cfg.multi_items, selected_index)
                        else insert(cfg.multi_items, button.Text) end
                        cfg.set(cfg.multi_items)
                    else 
                        cfg.set_visible(false)
                        library.current_open = nil
                        cfg.set(button.Text)
                    end
                end)
            end
        end

        items["dropdown"].MouseButton1Click:Connect(function()
            if cfg.open then
                cfg.set_visible(false)
                library.current_open = nil
            else
                library:close_element()
                cfg.open = true
                cfg.set_visible(true)
            end
        end)
        
        if cfg.tooltip then
            items["dropdown_object"].MouseEnter:Connect(function()
                library:show_tooltip(cfg.tooltip, items["dropdown_object"])
            end)
            items["dropdown_object"].MouseLeave:Connect(function()
                library:hide_tooltip()
            end)
        end

        config_flags[cfg.flag] = cfg.set
        cfg.refresh_options(cfg.options)
        cfg.set(cfg.default)
            
        return setmetatable(cfg, library)
    end
--

-- Player Dropdown
    function library:player_dropdown(options)
        options.items = library:get_players()
        local dropdown = self:dropdown(options)
        players.PlayerAdded:Connect(function() dropdown.refresh_options(library:get_players()) end)
        players.PlayerRemoving:Connect(function() task.wait(0.1) dropdown.refresh_options(library:get_players()) end)
        return dropdown
    end
--

-- Colorpicker (Linoria Style)
    function library:colorpicker(options) 
        local cfg = {
            name = options.name or "Color", 
            flag = options.flag or library:next_flag(),
            color = options.color or color(1, 1, 1),
            alpha = options.alpha and 1 - options.alpha or 0,
            open = false, 
            callback = options.callback or function() end,
            tooltip = options.tooltip,
            items = {},
        }

        local dragging_sat, dragging_hue, dragging_alpha = false, false, false
        local h, s, v = cfg.color:ToHSV() 
        local a = cfg.alpha 

        flags[cfg.flag] = {Color = cfg.color, Transparency = cfg.alpha}
        local items = cfg.items
        
        items["colorpicker_object"] = library:create("Frame", {
            Parent = self.items["elements"],
            BackgroundTransparency = 1,
            Size = dim2(1, 0, 0, library:scale(18)),
        })
        
        items["name"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font,
            Text = cfg.name,
            Parent = items["colorpicker_object"],
            Size = dim2(1, -30, 1, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = library:scale(12),
        })
        
        items["colorpicker"] = library:create("TextButton", {
            Text = "",
            AutoButtonColor = false,
            AnchorPoint = vec2(1, 0.5),
            Parent = items["colorpicker_object"],
            Position = dim2(1, 0, 0.5, 0),
            Size = dim_offset(library:scale(20), library:scale(14)),
            BackgroundColor3 = cfg.color,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["colorpicker"],
            Color = themes.preset.border,
            Thickness = 1,
        })

        items["colorpicker_holder"] = library:create("Frame", {
            Parent = items["colorpicker_object"],
            Position = dim2(1, -160, 0, library:scale(20)),
            Size = dim_offset(160, 0),
            BackgroundColor3 = themes.preset.background,
            ClipsDescendants = true,
            Visible = false,
            ZIndex = 50,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["colorpicker_holder"],
            Color = themes.preset.border,
            Thickness = 1,
        })

        items["saturation_holder"] = library:create("Frame", {
            Parent = items["colorpicker_holder"],
            Position = dim2(0, 6, 0, 6),
            Size = dim_offset(148, library:scale(100)),
            BackgroundColor3 = hsv(h, 1, 1),
            ZIndex = 51,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["saturation_holder"],
            Color = themes.preset.border,
            Thickness = 1,
        })
        
        items["sat"] = library:create("TextButton", {
            Parent = items["saturation_holder"],
            Size = dim2(1, 0, 1, 0),
            Text = "",
            AutoButtonColor = false,
            ZIndex = 52,
            BackgroundColor3 = rgb(255, 255, 255),
            BorderSizePixel = 0,
        })
        library:create("UIGradient", {Rotation = 270, Transparency = numseq{numkey(0, 0), numkey(1, 1)}, Parent = items["sat"], Color = rgbseq{rgbkey(0, rgb(0, 0, 0)), rgbkey(1, rgb(0, 0, 0))}})
        
        items["val"] = library:create("Frame", {
            Parent = items["saturation_holder"],
            Size = dim2(1, 0, 1, 0),
            BackgroundColor3 = rgb(255, 255, 255),
            ZIndex = 51,
            BorderSizePixel = 0,
        })
        library:create("UIGradient", {Parent = items["val"], Transparency = numseq{numkey(0, 0), numkey(1, 1)}})
        
        items["satvalpicker"] = library:create("Frame", {
            AnchorPoint = vec2(0.5, 0.5),
            Parent = items["saturation_holder"],
            Position = dim2(s, 0, 1 - v, 0),
            Size = dim_offset(library:scale(6), library:scale(6)),
            ZIndex = 53,
            BackgroundColor3 = rgb(255, 255, 255),
            BorderSizePixel = 0,
        })
        library:create("UICorner", {Parent = items["satvalpicker"], CornerRadius = dim(0, 3)})
        library:create("UIStroke", {Color = rgb(0, 0, 0), Parent = items["satvalpicker"], Thickness = 1})
        
        items["hue_gradient"] = library:create("TextButton", {
            Parent = items["colorpicker_holder"],
            Position = dim2(0, 6, 0, library:scale(112)),
            Size = dim_offset(148, library:scale(12)),
            BackgroundColor3 = rgb(255, 255, 255),
            AutoButtonColor = false,
            Text = "",
            ZIndex = 51,
            BorderSizePixel = 0,
        })
        library:create("UIGradient", {Color = rgbseq{rgbkey(0, rgb(255, 0, 0)), rgbkey(0.17, rgb(255, 255, 0)), rgbkey(0.33, rgb(0, 255, 0)), rgbkey(0.5, rgb(0, 255, 255)), rgbkey(0.67, rgb(0, 0, 255)), rgbkey(0.83, rgb(255, 0, 255)), rgbkey(1, rgb(255, 0, 0))}, Parent = items["hue_gradient"]})
        library:create("UIStroke", {Parent = items["hue_gradient"], Color = themes.preset.border, Thickness = 1})
        
        items["hue_picker"] = library:create("Frame", {
            AnchorPoint = vec2(0.5, 0.5),
            Parent = items["hue_gradient"],
            Position = dim2(h, 0, 0.5, 0),
            Size = dim_offset(library:scale(2), library:scale(14)),
            ZIndex = 52,
            BackgroundColor3 = rgb(255, 255, 255),
            BorderSizePixel = 0,
        })
        
        items["alpha_gradient"] = library:create("TextButton", {
            Parent = items["colorpicker_holder"],
            Position = dim2(0, 6, 0, library:scale(128)),
            Size = dim_offset(148, library:scale(12)),
            BackgroundColor3 = rgb(20, 20, 20),
            AutoButtonColor = false,
            Text = "",
            ZIndex = 51,
            BorderSizePixel = 0,
        })
        library:create("UIGradient", {Color = rgbseq{rgbkey(0, rgb(0, 0, 0)), rgbkey(1, rgb(255, 255, 255))}, Parent = items["alpha_gradient"]})
        library:create("UIStroke", {Parent = items["alpha_gradient"], Color = themes.preset.border, Thickness = 1})
        
        items["alpha_picker"] = library:create("Frame", {
            AnchorPoint = vec2(0.5, 0.5),
            Parent = items["alpha_gradient"],
            Position = dim2(1 - a, 0, 0.5, 0),
            Size = dim_offset(library:scale(2), library:scale(14)),
            ZIndex = 52,
            BackgroundColor3 = rgb(255, 255, 255),
            BorderSizePixel = 0,
        })

        function cfg.close()
            cfg.open = false
            library:tween(items["colorpicker_holder"], {Size = dim_offset(160, 0)}, Enum.EasingStyle.Quad, 0.15)
            task.delay(0.15, function()
                if not cfg.open then
                    items["colorpicker_holder"].Visible = false
                end
            end)
        end

        function cfg.set_visible(bool)
            if bool then
                items["colorpicker_holder"].Visible = true
                library:tween(items["colorpicker_holder"], {Size = dim_offset(160, library:scale(148))}, Enum.EasingStyle.Quad, 0.15)
                library.current_open = cfg
            else
                cfg.close()
            end
        end

        function cfg.set(new_color, alpha_val)
            if type(new_color) == "boolean" then return end 
            if new_color then h, s, v = new_color:ToHSV() end
            if alpha_val then a = alpha_val end 
            local Color = hsv(h, s, v)
            items["hue_picker"].Position = dim2(h, 0, 0.5, 0)
            items["alpha_picker"].Position = dim2(1 - a, 0, 0.5, 0)
            items["satvalpicker"].Position = dim2(s, 0, 1 - v, 0)
            items["colorpicker"].BackgroundColor3 = Color
            items["saturation_holder"].BackgroundColor3 = hsv(h, 1, 1)
            flags[cfg.flag] = {Color = Color, Transparency = a}
            cfg.callback(Color, a)
        end
        
        function cfg.update_color() 
            local mousePos = uis:GetMouseLocation() 
            local offset = vec2(mousePos.X, mousePos.Y - gui_offset) 
            if dragging_sat then    
                s = clamp((offset.X - items["sat"].AbsolutePosition.X) / items["sat"].AbsoluteSize.X, 0, 1)
                v = 1 - clamp((offset.Y - items["sat"].AbsolutePosition.Y) / items["sat"].AbsoluteSize.Y, 0, 1)
            elseif dragging_hue then
                h = clamp((offset.X - items["hue_gradient"].AbsolutePosition.X) / items["hue_gradient"].AbsoluteSize.X, 0, 1)
            elseif dragging_alpha then
                a = 1 - clamp((offset.X - items["alpha_gradient"].AbsolutePosition.X) / items["alpha_gradient"].AbsoluteSize.X, 0, 1)
            end
            cfg.set()
        end

        items["colorpicker"].MouseButton1Click:Connect(function()
            if cfg.open then
                cfg.set_visible(false)
                library.current_open = nil
            else
                library:close_element()
                cfg.open = true
                cfg.set_visible(true)
            end
        end)

        library:connection(uis.InputChanged, function(input)
            if (dragging_sat or dragging_hue or dragging_alpha) and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                cfg.update_color() 
            end
        end)

        library:connection(uis.InputEnded, function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging_sat = false
                dragging_hue = false
                dragging_alpha = false
            end
        end)    

        items["alpha_gradient"].InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging_alpha = true
            end
        end)
        
        items["hue_gradient"].InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging_hue = true
            end
        end)
        
        items["sat"].InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging_sat = true
            end
        end)
        
        if cfg.tooltip then
            items["colorpicker_object"].MouseEnter:Connect(function()
                library:show_tooltip(cfg.tooltip, items["colorpicker_object"])
            end)
            items["colorpicker_object"].MouseLeave:Connect(function()
                library:hide_tooltip()
            end)
        end
        
        cfg.set(cfg.color, cfg.alpha)
        config_flags[cfg.flag] = cfg.set

        return setmetatable(cfg, library)
    end 
--

-- Textbox (Linoria Style)
    function library:textbox(options) 
        local cfg = {
            name = options.name or "TextBox",
            placeholder = options.placeholder or "...",
            default = options.default or "",
            flag = options.flag or library:next_flag(),
            callback = options.callback or function() end,
            tooltip = options.tooltip,
            items = {},
        }

        flags[cfg.flag] = cfg.default
        local items = cfg.items
        
        items["textbox"] = library:create("Frame", {
            Parent = self.items["elements"],
            BackgroundTransparency = 1,
            Size = dim2(1, 0, 0, library:scale(36)),
        })
        
        items["name"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font,
            Text = cfg.name,
            Parent = items["textbox"],
            Size = dim2(1, 0, 0, library:scale(14)),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = library:scale(12),
        })
        
        items["input_holder"] = library:create("Frame", {
            Parent = items["textbox"],
            Position = dim2(0, 0, 0, library:scale(16)),
            Size = dim2(1, 0, 0, library:scale(20)),
            BackgroundColor3 = themes.preset.element_bg,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["input_holder"],
            Color = themes.preset.element_border,
            Thickness = 1,
        })
        
        items["input"] = library:create("TextBox", {
            FontFace = fonts.small,
            Text = cfg.default,
            Parent = items["input_holder"],
            Position = dim2(0, 8, 0, 0),
            Size = dim2(1, -16, 1, 0),
            PlaceholderText = cfg.placeholder,
            PlaceholderColor3 = themes.preset.font_dark,
            CursorPosition = -1,
            ClearTextOnFocus = false,
            TextSize = library:scale(11),
            TextColor3 = themes.preset.font,
            TextXAlignment = Enum.TextXAlignment.Left,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
        })
        
        function cfg.set(text) 
            flags[cfg.flag] = text
            items["input"].Text = text
            cfg.callback(text)
        end 
        
        items["input"]:GetPropertyChangedSignal("Text"):Connect(function()
            cfg.set(items["input"].Text) 
        end)

        items["input"].Focused:Connect(function()
            local stroke = items["input_holder"]:FindFirstChildOfClass("UIStroke")
            library:tween(stroke, {Color = themes.preset.accent})
        end)

        items["input"].FocusLost:Connect(function()
            local stroke = items["input_holder"]:FindFirstChildOfClass("UIStroke")
            library:tween(stroke, {Color = themes.preset.element_border})
        end)
        
        if cfg.tooltip then
            items["textbox"].MouseEnter:Connect(function()
                library:show_tooltip(cfg.tooltip, items["textbox"])
            end)
            items["textbox"].MouseLeave:Connect(function()
                library:hide_tooltip()
            end)
        end

        config_flags[cfg.flag] = cfg.set

        return setmetatable(cfg, library)
    end
--

-- Button (Linoria Style)
    function library:button(options) 
        local cfg = {
            name = options.name or "Button",
            callback = options.callback or function() end,
            tooltip = options.tooltip,
            items = {},
        }
        
        local items = cfg.items
        
        items["button_element"] = library:create("Frame", {
            Parent = self.items["elements"],
            BackgroundTransparency = 1,
            Size = dim2(1, 0, 0, library:scale(22)),
        })
        
        items["button"] = library:create("TextButton", {
            FontFace = fonts.small,
            Text = cfg.name,
            AutoButtonColor = false,
            Parent = items["button_element"],
            Size = dim2(1, 0, 1, 0),
            BackgroundColor3 = themes.preset.element_bg,
            TextColor3 = themes.preset.font,
            TextSize = library:scale(12),
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["button"],
            Color = themes.preset.element_border,
            Thickness = 1,
        })

        items["button"].MouseButton1Click:Connect(function()
            cfg.callback()
            
            local stroke = items["button"]:FindFirstChildOfClass("UIStroke")
            library:tween(stroke, {Color = themes.preset.accent}, Enum.EasingStyle.Quad, 0.1)
            library:tween(items["button"], {BackgroundColor3 = themes.preset.darker}, Enum.EasingStyle.Quad, 0.1)
            
            task.delay(0.15, function()
                library:tween(stroke, {Color = themes.preset.element_border}, Enum.EasingStyle.Quad, 0.1)
                library:tween(items["button"], {BackgroundColor3 = themes.preset.element_bg}, Enum.EasingStyle.Quad, 0.1)
            end)
        end)
        
        items["button"].MouseEnter:Connect(function()
            library:tween(items["button"], {BackgroundColor3 = themes.preset.darker})
        end)
        
        items["button"].MouseLeave:Connect(function()
            library:tween(items["button"], {BackgroundColor3 = themes.preset.element_bg})
        end)
        
        if cfg.tooltip then
            items["button_element"].MouseEnter:Connect(function()
                library:show_tooltip(cfg.tooltip, items["button_element"])
            end)
            items["button_element"].MouseLeave:Connect(function()
                library:hide_tooltip()
            end)
        end
        
        return setmetatable(cfg, library)
    end 
--

-- Keybind (Linoria Style)
    function library:keybind(options) 
        local cfg = {
            flag = options.flag or library:next_flag(),
            callback = options.callback or function() end,
            name = options.name or "Keybind", 
            key = options.key or nil, 
            mode = options.mode or "Toggle",
            active = options.default or false, 
            open = false,
            binding = nil, 
            tooltip = options.tooltip,
            show_in_list = options.show_in_list ~= false,
            items = {},
        }

        local keys_map = {
            [Enum.KeyCode.LeftShift] = "LS", [Enum.KeyCode.RightShift] = "RS",
            [Enum.KeyCode.LeftControl] = "LC", [Enum.KeyCode.RightControl] = "RC",
            [Enum.KeyCode.Insert] = "INS", [Enum.KeyCode.Backspace] = "BS",
            [Enum.KeyCode.Return] = "Ent", [Enum.KeyCode.LeftAlt] = "LA",
            [Enum.KeyCode.RightAlt] = "RA", [Enum.KeyCode.CapsLock] = "CAPS",
            [Enum.UserInputType.MouseButton1] = "MB1",
            [Enum.UserInputType.MouseButton2] = "MB2",
            [Enum.UserInputType.MouseButton3] = "MB3",
            [Enum.KeyCode.Escape] = "ESC", [Enum.KeyCode.Space] = "SPC",
        }

        flags[cfg.flag] = {mode = cfg.mode, key = cfg.key, active = cfg.active}
        local items = cfg.items
        
        items["keybind_element"] = library:create("Frame", {
            Parent = self.items["elements"],
            BackgroundTransparency = 1,
            Size = dim2(1, 0, 0, library:scale(18)),
        })
        
        items["name"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font,
            Text = cfg.name,
            Parent = items["keybind_element"],
            Size = dim2(1, -55, 1, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = library:scale(12),
        })
        
        items["keybind_holder"] = library:create("TextButton", {
            Text = "",
            Parent = items["keybind_element"],
            AutoButtonColor = false,
            AnchorPoint = vec2(1, 0.5),
            Size = dim_offset(library:scale(50), library:scale(16)),
            Position = dim2(1, 0, 0.5, 0),
            BackgroundColor3 = themes.preset.element_bg,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["keybind_holder"],
            Color = themes.preset.element_border,
            Thickness = 1,
        })
        
        items["key"] = library:create("TextLabel", {
            FontFace = fonts.small,
            TextColor3 = themes.preset.font_dark,
            Text = "None",
            Parent = items["keybind_holder"],
            Size = dim2(1, 0, 1, 0),
            BackgroundTransparency = 1,
            TextSize = library:scale(10),
        })

        items["dropdown"] = library:create("Frame", {
            Parent = items["keybind_element"],
            Position = dim2(1, -50, 0, library:scale(20)),
            Size = dim_offset(library:scale(50), 0),
            BackgroundColor3 = themes.preset.background,
            ClipsDescendants = true,
            Visible = false,
            ZIndex = 50,
            BorderSizePixel = 0,
        })
        
        library:create("UIStroke", {
            Parent = items["dropdown"],
            Color = themes.preset.border,
            Thickness = 1,
        })
        
        items["mode_list"] = library:create("Frame", {
            Parent = items["dropdown"],
            Size = dim2(1, 0, 1, 0),
            BackgroundTransparency = 1,
        })
        library:create("UIListLayout", {Parent = items["mode_list"], Padding = dim(0, 0), SortOrder = Enum.SortOrder.LayoutOrder})
        library:create("UIPadding", {Parent = items["mode_list"], PaddingTop = dim(0, 2), PaddingBottom = dim(0, 2)})
        
        local mode_options = {"Hold", "Toggle", "Always"}
        local mode_buttons = {}
        
        for _, option in ipairs(mode_options) do                        
            local btn = library:create("TextButton", {
                FontFace = fonts.small,
                TextColor3 = themes.preset.font_dark,
                Text = option,
                Parent = items["mode_list"],
                Size = dim2(1, 0, 0, library:scale(16)),
                BackgroundTransparency = 1,
                TextSize = library:scale(10),
                ZIndex = 51,
                AutoButtonColor = false,
            })
            mode_buttons[option] = btn
            
            btn.MouseEnter:Connect(function()
                if cfg.mode ~= option then
                    library:tween(btn, {TextColor3 = themes.preset.font})
                end
            end)
            
            btn.MouseLeave:Connect(function()
                if cfg.mode ~= option then
                    library:tween(btn, {TextColor3 = themes.preset.font_dark})
                end
            end)
            
            btn.MouseButton1Click:Connect(function()
                cfg.mode = option
                for name, b in pairs(mode_buttons) do
                    b.TextColor3 = name == option and themes.preset.accent or themes.preset.font_dark
                end
                if option == "Always" then 
                    cfg.active = true 
                    cfg.callback(true) 
                end
                flags[cfg.flag].mode = option
                if cfg.show_in_list and library.keybinds[cfg.flag] then
                    library.keybinds[cfg.flag].mode = option
                    library:update_keybind_list()
                end
                cfg.close()
                library.current_open = nil
            end)
        end
        mode_buttons[cfg.mode].TextColor3 = themes.preset.accent

        function cfg.close()
            cfg.open = false
            library:tween(items["dropdown"], {Size = dim_offset(library:scale(50), 0)}, Enum.EasingStyle.Quad, 0.15)
            task.delay(0.15, function()
                if not cfg.open then
                    items["dropdown"].Visible = false
                end
            end)
        end

        function cfg.set(input)
            if type(input) == "boolean" then 
                cfg.active = input
                if cfg.mode == "Always" then cfg.active = true end
                if cfg.show_in_list then
                    library:set_keybind_active(cfg.flag, cfg.active)
                end
            elseif tostring(input):find("Enum") then 
                input = input.Name == "Escape" and "NONE" or input
                cfg.key = input or "NONE"
                local key_text = "None"
                if cfg.key and tostring(cfg.key) ~= "Enums" and cfg.key ~= "NONE" then
                    key_text = keys_map[cfg.key] or tostring(cfg.key):gsub("Enum.KeyCode.", ""):gsub("Enum.UserInputType.", "")
                end
                if cfg.show_in_list then
                    library:register_keybind(cfg.name, cfg.flag, cfg.key, cfg.mode)
                end
            elseif type(input) == "table" then 
                if type(input.key) == "string" and input.key ~= "NONE" then
                    pcall(function() input.key = library:convert_enum(input.key) end)
                end
                if input.key == Enum.KeyCode.Escape then input.key = "NONE" end
                cfg.key = input.key or "NONE"
                cfg.mode = input.mode or "Toggle"
                if input.active ~= nil then cfg.active = input.active end
                for name, b in pairs(mode_buttons) do
                    b.TextColor3 = name == cfg.mode and themes.preset.accent or themes.preset.font_dark
                end
                if cfg.show_in_list then
                    library:register_keybind(cfg.name, cfg.flag, cfg.key, cfg.mode)
                    library:set_keybind_active(cfg.flag, cfg.active)
                end
            end 
            cfg.callback(cfg.active)
            local text = "None"
            if cfg.key and tostring(cfg.key) ~= "Enums" and cfg.key ~= "NONE" then
                text = keys_map[cfg.key] or tostring(cfg.key):gsub("Enum.KeyCode.", ""):gsub("Enum.UserInputType.", "")
            end
            items["key"].Text = text
            flags[cfg.flag] = {mode = cfg.mode, key = cfg.key, active = cfg.active}
        end

        items["keybind_holder"].MouseButton1Down:Connect(function()
            task.wait()
            items["key"].Text = "..."   
            cfg.binding = library:connection(uis.InputBegan, function(keycode)  
                cfg.set(keycode.KeyCode ~= Enum.KeyCode.Unknown and keycode.KeyCode or keycode.UserInputType)
                cfg.binding:Disconnect() 
                cfg.binding = nil
            end)
        end)

        items["keybind_holder"].MouseButton2Down:Connect(function()
            if cfg.open then
                cfg.close()
                library.current_open = nil
            else
                library:close_element()
                cfg.open = true
                items["dropdown"].Visible = true
                library:tween(items["dropdown"], {Size = dim_offset(library:scale(50), library:scale(54))}, Enum.EasingStyle.Quad, 0.15)
                library.current_open = cfg
            end
        end)

        library:connection(uis.InputBegan, function(input, game_event) 
            if not game_event then
                local selected_key = input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode or input.UserInputType
                if selected_key == cfg.key then 
                    if cfg.mode == "Toggle" then 
                        cfg.active = not cfg.active
                        cfg.set(cfg.active)
                    elseif cfg.mode == "Hold" then 
                        cfg.set(true)
                    end
                end
            end
        end)    

        library:connection(uis.InputEnded, function(input, game_event) 
            if game_event then return end 
            local selected_key = input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode or input.UserInputType
            if selected_key == cfg.key and cfg.mode == "Hold" then 
                cfg.set(false)
            end
        end)
        
        if cfg.tooltip then
            items["keybind_element"].MouseEnter:Connect(function()
                library:show_tooltip(cfg.tooltip, items["keybind_element"])
            end)
            items["keybind_element"].MouseLeave:Connect(function()
                library:hide_tooltip()
            end)
        end
        
        if cfg.show_in_list then
            library:register_keybind(cfg.name, cfg.flag, cfg.key, cfg.mode)
        end
        
        cfg.set({mode = cfg.mode, active = cfg.active, key = cfg.key})           
        config_flags[cfg.flag] = cfg.set

        return setmetatable(cfg, library)
    end
--

-- Divider (Linoria Style)
    function library:divider(options)
        local cfg = {
            items = {},
        }
        
        cfg.items["divider"] = library:create("Frame", {
            Parent = self.items["elements"],
            Size = dim2(1, 0, 0, 1),
            BackgroundColor3 = themes.preset.divider,
            BorderSizePixel = 0,
        })
        
        return setmetatable(cfg, library)
    end
--

-- Header (Linoria Style - Text header within groupbox)
    function library:header(options)
        local cfg = {
            name = options.name or "Header",
            items = {},
        }
        
        cfg.items["header"] = library:create("TextLabel", {
            FontFace = fonts.font,
            TextColor3 = themes.preset.font,
            Text = cfg.name,
            Parent = self.items["elements"],
            Size = dim2(1, 0, 0, library:scale(16)),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Center,
            TextSize = library:scale(13),
        })
        
        return setmetatable(cfg, library)
    end
--

return library
